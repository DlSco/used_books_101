<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.usedBooks.frontStage.book.mapper.BookFrontMapper">


    <sql id="Base_Column_List">
      a.id, a.isbn, a.name, a.author, a.publish_house, a.picture_url, a.original_price
     </sql>

    <sql id="publish_column_list">
       b.publish_type,b.price,b.book_old_state,b.user_id,b.update_time,b.description,b.remark
      </sql>

    <sql id="need_user_columns">
        c.user_name
      </sql>

    <sql id="publish_user_columns">
    d.publish_type,d.price,d.book_old_state,d.user_name,d.user_id,d.update_time
  </sql>

    <sql id="BookDetailVo">
        d.publish_type,d.price,d.book_old_state,d.user_name,d.user_id,d.description,d.remark
    </sql>
    <select id="toList" resultType="com.usedBooks.frontStage.book.vo.BookVo">
        select
        <include refid="Base_Column_List" />,
        <include refid="publish_user_columns"></include> from book a
        inner join
        (select <include refid="publish_column_list"></include>,<include refid="need_user_columns"/>
        from publish b
        inner join user c on b.user_id  = c.id) as d
        <where>
            <if test="userId!=null and publishType!=null">
                and d.user_id = #{userId} and d.publish_type = #{publishType}
            </if>
            <if test="publishType != null">
                and d.publish_type = #{publishType}
            </if>
            <if test="isDrop != null">
                and d.is_drop = #{isDrop}
            </if>
            <if test="status != null and status != '' ">
                and d.status = #{status}
            </if>
            <if test="keyword!=null">
                and (a.name like #{keyword} or a.isbn like #{keyword})
            </if>

        </where>
        <if test="sname != null and sname != '' and sortRule != null and sortRule != ''">
            order by d.${sname} ${sortRule}
        </if>
    </select>

    <select id="toDetail" resultType="com.usedBooks.frontStage.book.vo.BookDetailVo">
        select
        <include refid="BookDetailVo" />,
        <include refid="publish_user_columns"></include> from book a
        inner join
        (select <include refid="publish_column_list"></include>,<include refid="need_user_columns"/>
        from publish b
        inner join user c on b.user_id  = c.id) as d
        where a.id = #{id}
    </select>
</mapper>